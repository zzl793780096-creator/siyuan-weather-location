# 思源笔记天气与位置插件

## 功能概述

这是一个为思源笔记开发的插件，可以自动查询天气和位置信息，并通过模板插入到每日笔记中。

## 主要功能

### 1. 天气查询
- 支持多种天气数据源：
  - **OpenWeatherMap** - 国际通用，覆盖全球
  - **高德地图** - 国内服务，数据准确
  - **和风天气** - 国内服务，专业气象数据

- 提供详细的天气信息：
  - 天气状况（晴朗、多云、雨等）
  - 当前温度、体感温度
  - 最高/最低温度
  - 湿度、气压、风速
  - 日出日落时间
  - 能见度

### 2. 位置查询
- 多种定位方式：
  - **IP定位** - 自动获取，无需配置，精度为城市级
  - **高德定位** - 浏览器定位，精度为米级
  - **手动设置** - 固定位置，适合不需要变化的用户

- 提供详细的位置信息：
  - 城市、国家、区域
  - 经纬度坐标
  - IP地址、时区

### 3. 模板系统
- 丰富的模板变量
- 支持嵌套变量（如 `{{weather.temperature}}`）
- 支持条件语句（`{{#if}}...{{/if}}`）
- 多种预设模板（默认、简洁、表格）
- 完全可自定义

### 4. 自动插入
- 创建每日笔记时自动插入
- 可开关控制
- 延迟插入，确保文档已创建

### 5. 多种使用方式
- 自动插入
- 命令面板
- 块右键菜单
- 可绑定快捷键

## 文件结构

```
siyuan-weather-location-plugin/
├── src/                          # 源代码
│   ├── index.ts                  # 插件主入口
│   ├── weather.ts                # 天气服务
│   ├── location.ts               # 位置服务
│   ├── template.ts               # 模板引擎
│   └── setting.ts                # 设置面板
├── i18n/                         # 国际化
│   ├── zh_CN.json               # 中文
│   └── en_US.json               # 英文
├── package.json                  # 项目配置
├── vite.config.ts               # Vite配置
├── tsconfig.json                # TypeScript配置
├── plugin.json                  # 插件配置
├── icon.svg                     # 插件图标
├── README.md                    # 英文文档
├── README_zh_CN.md              # 中文文档
├── INSTALL.md                   # 安装指南
├── preview.md                   # 功能预览
├── install.sh                   # macOS/Linux安装脚本
├── install.ps1                  # Windows安装脚本
├── build.sh                     # macOS/Linux构建脚本
└── build.ps1                    # Windows构建脚本
```

## 安装步骤

### 快速安装（推荐）

**macOS / Linux:**
```bash
chmod +x install.sh
./install.sh
```

**Windows:**
```powershell
.\install.ps1
```

### 手动安装

1. 安装依赖
```bash
pnpm install
```

2. 构建插件
```bash
pnpm run build
```

3. 复制到插件目录

**macOS:**
```bash
mkdir -p ~/Library/Application\ Support/siyuan/plugins/siyuan-weather-location
cp -r dist/* ~/Library/Application\ Support/siyuan/plugins/siyuan-weather-location/
cp plugin.json icon.svg ~/Library/Application\ Support/siyuan/plugins/siyuan-weather-location/
```

**Linux:**
```bash
mkdir -p ~/.config/siyuan/plugins/siyuan-weather-location
cp -r dist/* ~/.config/siyuan/plugins/siyuan-weather-location/
cp plugin.json icon.svg ~/.config/siyuan/plugins/siyuan-weather-location/
```

**Windows:**
```powershell
$dir = "$env:APPDATA\siyuan\plugins\siyuan-weather-location"
New-Item -ItemType Directory -Path $dir -Force
Copy-Item -Path "dist\*" -Destination $dir -Recurse
Copy-Item -Path "plugin.json", "icon.svg" -Destination $dir
```

4. 重启思源笔记并启用插件

## 配置说明

### 1. 天气设置

选择天气数据源并配置 API Key：

| 数据源 | 免费额度 | 申请地址 |
|--------|----------|----------|
| OpenWeatherMap | 1000次/天 | https://openweathermap.org/api |
| 高德地图 | 5000次/天 | https://lbs.amap.com/ |
| 和风天气 | 1000次/天 | https://dev.qweather.com/ |

### 2. 位置设置

| 方式 | 精度 | 配置 |
|------|------|------|
| IP定位 | 城市级 | 无需配置 |
| 高德定位 | 米级 | 需要高德Key |
| 手动设置 | 固定 | 输入城市名和坐标 |

### 3. 模板设置

使用模板变量自定义输出格式：

```markdown
## 今日天气与位置

🌤 **天气**: {{weather.description}}
🌡 **温度**: {{weather.temperature}}°C
💧 **湿度**: {{weather.humidity}}%
📍 **位置**: {{location.city}}
⏰ **时间**: {{time}}
```

## 模板变量

### 天气变量
- `{{weather.description}}` - 天气描述
- `{{weather.temperature}}` - 当前温度(°C)
- `{{weather.humidity}}` - 湿度(%)
- `{{weather.windSpeed}}` - 风速(m/s)
- `{{weather.pressure}}` - 气压(hPa)
- `{{weather.visibility}}` - 能见度(km)
- `{{weather.feelsLike}}` - 体感温度(°C)
- `{{weather.tempMin}}` - 最低温度(°C)
- `{{weather.tempMax}}` - 最高温度(°C)
- `{{weather.sunrise}}` - 日出时间
- `{{weather.sunset}}` - 日落时间

### 位置变量
- `{{location.city}}` - 城市
- `{{location.country}}` - 国家
- `{{location.region}}` - 区域
- `{{location.lat}}` - 纬度
- `{{location.lon}}` - 经度
- `{{location.ip}}` - IP地址
- `{{location.timezone}}` - 时区

### 其他变量
- `{{time}}` - 当前时间

## 使用方式

### 方式一：自动插入（推荐）
在设置中开启"创建每日笔记时自动插入"，每次创建每日笔记时会自动插入天气和位置信息。

### 方式二：命令面板
- 按 `Ctrl+P` 打开命令面板
- 搜索 "天气" 或 "位置"
- 选择相应命令

### 方式三：块菜单
- 右键点击任意块
- 选择插入选项

### 方式四：快捷键
在思源笔记设置中为命令绑定快捷键。

## 开发

### 环境要求
- Node.js 16+
- pnpm

### 开发模式
```bash
pnpm install
pnpm run dev
```

### 构建发布
```bash
./build.sh        # macOS/Linux
.\build.ps1       # Windows
```

## 技术实现

### 天气查询
- 使用第三方天气 API
- 支持多数据源切换
- 数据缓存机制（30分钟）
- 失败时返回模拟数据

### 位置查询
- IP 定位使用 ipapi.co 和 ip-api.com
- 浏览器定位使用 Navigator.geolocation
- 支持手动设置固定位置
- 数据缓存机制（30分钟）

### 模板引擎
- 支持简单变量替换
- 支持嵌套对象访问
- 支持条件语句
- 支持循环语句

### 思源笔记集成
- 监听每日笔记创建事件
- 使用 Kernel API 插入内容
- 注册命令和菜单
- 提供设置面板

## 注意事项

1. **API Key 安全**: 请妥善保管 API Key，不要提交到公共仓库
2. **免费额度**: 注意各服务商的免费调用额度限制
3. **网络要求**: 插件需要网络连接才能正常工作
4. **隐私说明**: IP定位会发送IP地址到第三方服务

## 故障排除

### 无法获取天气
- 检查 API Key 是否正确
- 检查网络连接
- 查看控制台错误信息

### 位置不准确
- IP定位精度有限，建议改用高德定位或手动设置
- 检查定位权限是否开启

### 插件不显示
- 检查文件是否正确复制
- 重启思源笔记
- 检查 plugin.json 是否存在

## 许可证

MIT License

## 更新日志

### v1.0.0
- 初始版本
- 支持天气查询（OpenWeatherMap、高德、和风）
- 支持位置查询（IP、高德、手动）
- 支持自定义模板
- 支持自动插入每日笔记
